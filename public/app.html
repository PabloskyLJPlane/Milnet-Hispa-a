<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MILNET Hispaña — Command</title>

  <link rel="stylesheet" href="styles.css">

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="firebase.js"></script>

  <style>
    /* Mejoras visuales solo en app */
    .topbar{
      display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;
      padding:12px 14px;border:1px solid rgba(148,163,184,.12);
      background:linear-gradient(180deg, rgba(17,17,20,.86), rgba(12,12,16,.65));
      border-radius:14px;
      margin-bottom:12px;
    }
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:10px}
    @media(max-width:1100px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr));}}
    @media(max-width:640px){.kpis{grid-template-columns:1fr;}}
    .kpi{
      border:1px solid rgba(148,163,184,.12);
      background:rgba(17,17,20,.65);
      border-radius:14px;
      padding:12px;
    }
    .kpi .label{letter-spacing:2px;color:#6b7280}
    .kpi .value{font-weight:900;font-size:20px;margin-top:6px}
    .grid2{display:grid;grid-template-columns:420px 1fr;gap:12px;margin-top:12px}
    @media(max-width:980px){.grid2{grid-template-columns:1fr;}}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(148,163,184,.16);
      background:rgba(17,17,20,.55);
      font-size:12px;color:#cbd5e1;
    }
    .muted{color:#9ca3af}
    .dangerBox{
      border:1px solid rgba(239,68,68,.35);
      background:rgba(239,68,68,.06);
      border-radius:14px;padding:12px;
    }
    .okBox{
      border:1px solid rgba(34,197,94,.25);
      background:rgba(34,197,94,.06);
      border-radius:14px;padding:12px;
    }
  </style>
</head>

<body>
  <div class="gridbg"></div>
  <div class="scanline"></div>

  <div class="shell">
    <!-- Sidebar -->
    <aside class="side card" style="background:var(--panel2);">
      <div class="pill mono">INTERNO • SEGURO</div>
      <h3 style="margin:12px 0 6px 0;">MILNET Hispaña</h3>
      <div class="mono small" id="who">CARGANDO PERFIL…</div>

      <div class="card" style="margin-top:12px; padding:12px;">
        <div class="mono small" style="letter-spacing:2px;color:#6b7280">CUERPO</div>
        <div id="branchName" style="font-weight:800;margin-top:6px">—</div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
          <button class="btn btn2" style="padding:10px" onclick="setBranch('ETH')">ETH</button>
          <button class="btn btn2" style="padding:10px" onclick="setBranch('EAEH')">EAEH</button>
          <button class="btn btn2" style="padding:10px" onclick="setBranch('ARM')">ARM</button>
          <button class="btn btn2" style="padding:10px" onclick="setBranch('PMH')">PMH</button>
          <button class="btn btn2" style="padding:10px" onclick="setBranch('GCH')">GCH</button>
        </div>
      </div>

      <div class="nav" style="margin-top:12px">
        <button class="btn btn2" data-tab="pageDash">CENTRO DE MANDO</button>
        <button class="btn btn2" data-tab="pageUnits">UNIDADES</button>
        <button class="btn btn2" data-tab="pagePeople">PERSONAL</button>
        <button class="btn btn2" data-tab="pageChat">CHAT</button>
        <button class="btn btn2" data-tab="pageEquip">EQUIPOS</button>
        <button class="btn btn2" data-tab="pageOrders">COMUNICADOS</button>
        <button id="tabCUM" class="btn btn2" data-tab="pageCUM">CUM</button>

        <!-- Panel Rey -->
        <button id="btnAdmin" class="btn" style="display:none" onclick="window.location.href='admin.html'">
          PANEL REY
        </button>

        <button id="logout" class="btn btndanger">CERRAR SESIÓN</button>
      </div>

      <button id="btnSeed" class="btn" style="display:none;margin-top:12px" onclick="seedHispañaOrgConfig()">
        INICIALIZAR SISTEMA
      </button>

      <div class="mono foot2">TODO ACCESO ES REGISTRADO</div>
    </aside>

    <!-- Main -->
    <main class="main">

      <!-- DASHBOARD -->
      <section id="pageDash" class="card fade page">
        <div class="topbar">
          <div>
            <h2 style="margin:0">Centro de Mando</h2>
            <div class="small muted">Resumen operativo por cuerpo/unidad + accesos rápidos.</div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <span class="chip mono"><span style="color:#86efac">●</span> MILNET ONLINE</span>
            <span id="dashModeIndicator" class="chip mono">—</span>
            <button class="btn" style="max-width:220px;margin-top:0" onclick="safeRenderDashboard(true)">REFRESCAR</button>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="mono small label">TU CUERPO</div>
            <div class="value" id="dashBranch">—</div>
            <div class="small muted" id="dashBranchSub">Cargando…</div>
          </div>
          <div class="kpi">
            <div class="mono small label">TU UNIDAD</div>
            <div class="value" id="dashUnit">—</div>
            <div class="small muted" id="dashUnitSub">Cargando…</div>
          </div>
          <div class="kpi">
            <div class="mono small label">RANGO</div>
            <div class="value" id="dashRank">—</div>
            <div class="small muted" id="dashRankSub">Cargando…</div>
          </div>
          <div class="kpi">
            <div class="mono small label">CLEARANCE</div>
            <div class="value" id="dashClr">—</div>
            <div class="small muted" id="dashClrSub">Cargando…</div>
          </div>
        </div>

        <div class="grid2">
          <div class="card" style="padding:14px">
            <div class="mono small" style="letter-spacing:2px;color:#6b7280">ACCIONES RÁPIDAS</div>

            <div style="margin-top:10px;display:grid;grid-template-columns:1fr;gap:10px">
              <button class="btn" onclick="openTabSafe('pageOrders')">Ver Comunicados</button>
              <button class="btn btn2" onclick="openTabSafe('pageChat')">Abrir Chat</button>
              <button class="btn btn2" onclick="openTabSafe('pageUnits')">Ver Unidades</button>
              <button class="btn btn2" onclick="openTabSafe('pageEquip')">Inventario</button>
              <button class="btn btn2" onclick="openTabSafe('pageCUM')">CUM</button>
            </div>

            <div class="okBox" style="margin-top:12px">
              <div style="font-weight:900">Tip</div>
              <div class="small muted" style="margin-top:6px">
                Si algo no carga: F12 → Console para ver el error exacto.
              </div>
            </div>

            <div class="dangerBox" style="margin-top:12px">
              <div style="font-weight:900;color:#fca5a5">Estado Storage</div>
              <div class="small muted" style="margin-top:6px">
                Tu Firebase Storage gratis está bloqueado por región. Subidas de archivos pueden fallar.
              </div>
            </div>
          </div>

          <div class="card" style="padding:14px">
            <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:center">
              <div>
                <div class="mono small" style="letter-spacing:2px;color:#6b7280">FEED RÁPIDO</div>
                <div class="small muted" style="margin-top:4px">Últimos comunicados / actividad reciente.</div>
              </div>
              <button class="btn btn2" style="max-width:220px;margin-top:0" onclick="safeRenderDashboard(true)">
                RECARGAR
              </button>
            </div>

            <div id="dashFeed" style="margin-top:12px">Cargando…</div>
          </div>
        </div>
      </section>

      <!-- Unidades -->
      <section id="pageUnits" class="card fade page" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div>
            <h2 style="margin:0">Unidades</h2>
            <div class="small">Crea y lista unidades por cuerpo (ETH/EAEH/ARM/PMH/GCH).</div>
          </div>
          <button id="btnCreateUnit" class="btn" style="display:none;max-width:220px"
            onclick="document.getElementById('createUnitBox').style.display='block'">
            + NUEVA UNIDAD
          </button>
        </div>

        <div id="createUnitBox" class="card" style="display:none;margin-top:14px;padding:14px">
          <div class="mono small" style="letter-spacing:2px;color:#6b7280">CREAR UNIDAD</div>
          <input id="uType" class="input" placeholder="Tipo (División, Comando, Ala, Flota...)" />
          <input id="uName" class="input" placeholder="Nombre" />
          <input id="uBase" class="input" placeholder="Base" />
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn" style="max-width:220px" onclick="createUnit?.()">CREAR</button>
            <button class="btn btn2" style="max-width:220px"
              onclick="document.getElementById('createUnitBox').style.display='none'">CANCELAR</button>
          </div>
        </div>

        <div id="unitsList" style="margin-top:14px"></div>
      </section>

      <!-- Personal -->
      <section id="pagePeople" class="card fade page" style="display:none">
        <h2 style="margin-top:0">Personal</h2>
        <div class="small">Listado por cuerpo con rango/unidad.</div>
        <div id="peopleList" style="margin-top:14px"></div>
      </section>

      <!-- Chat -->
      <section id="pageChat" class="card fade page" style="display:none">
        <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:center">
          <div>
            <h2 style="margin:0">Chat MILNET</h2>
            <div class="small">Canales por unidad, por cuerpo, Alto Mando y DM privado.</div>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <select id="channelSelect" class="input" style="max-width:320px;margin-top:0">
              <option value="">Cargando canales…</option>
            </select>
            <button class="btn" type="button" style="max-width:220px;margin-top:0" onclick="refreshChannels?.()">
              ACTUALIZAR
            </button>
          </div>
        </div>

        <div id="chatMeta" class="small" style="margin-top:12px;color:#9ca3af"></div>

        <div id="chatBox" class="card"
             style="margin-top:12px;height:55vh;overflow:auto;padding:14px;background:#0d0d10">
          <div class="small">Selecciona un canal para empezar.</div>
        </div>

        <form id="chatForm" style="margin-top:12px;display:flex;gap:10px">
          <input id="chatInput" class="input" placeholder="Escribe un mensaje..." style="margin-top:0;flex:1" disabled />
          <button id="sendBtn" class="btn" type="submit" style="max-width:220px;margin-top:0" disabled>ENVIAR</button>
        </form>
      </section>

      <!-- Equipos -->
      <section id="pageEquip" class="card fade page" style="display:none">
        <h2 style="margin-top:0">Equipos</h2>
        <div class="small">Inventario por unidad.</div>
        <div id="equipList" style="margin-top:14px"></div>
      </section>

      <!-- Comunicados -->
      <section id="pageOrders" class="card fade page" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div>
            <h2 style="margin:0">Comunicados</h2>
            <div class="small">Órdenes y avisos por cuerpo.</div>
          </div>
          <button id="btnNewOrder" class="btn" style="max-width:220px;margin-top:0;display:none"
            onclick="document.getElementById('ordersCreateBox').style.display='block'">
            + NUEVO COMUNICADO
          </button>
        </div>

        <div id="ordersCreateBox" class="card" style="display:none;margin-top:14px;padding:14px">
          <div class="mono small" style="letter-spacing:2px;color:#6b7280">PUBLICAR</div>

          <select id="oPriority" class="input">
            <option>NORMAL</option>
            <option>ALTA</option>
            <option>URGENTE</option>
          </select>

          <select id="oScope" class="input">
            <option value="CUERPO">Para todo el cuerpo</option>
            <option value="UNIDAD">Solo mi unidad</option>
          </select>

          <input id="oTitle" class="input" placeholder="Título" />
          <textarea id="oBody" class="input" style="height:120px;resize:vertical" placeholder="Contenido…"></textarea>

          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn" style="max-width:220px" onclick="createOrder?.()">PUBLICAR</button>
            <button class="btn btn2" style="max-width:220px"
              onclick="document.getElementById('ordersCreateBox').style.display='none'">CANCELAR</button>
          </div>
        </div>

        <div id="ordersList" style="margin-top:14px"></div>
      </section>

      <!-- CUM -->
      <section id="pageCUM" class="card fade page" style="display:none">
        <h2 style="margin-top:0">Centro Unificado de Mando (CUM)</h2>
        <div class="small">Crisis, coordinación, recursos.</div>
        <div id="cumFeed" style="margin-top:14px">Cargando…</div>
      </section>

    </main>
  </div>

  <!-- Scripts: orden MUY importante -->
  <script src="ui.js"></script>
  <script src="milnet.js"></script>
  <script src="modules.js"></script>

  <!-- ✅ ESTOS DOS TE FALTABAN -->
  <script src="units.js"></script>
  <script src="personnel.js"></script>

  <script src="seed_hispana.js"></script>

  <script src="chat.js"></script>
  <script src="equipment.js"></script>
  <script src="orders.js"></script>
  <script src="cum.js"></script>
  <script src="dashboard.js"></script>

  <script>
    const auth = initFirebase();
    const firestore = db();

    // Fallback tab system (si tu openTab de ui.js no funciona o no existe)
    function openTabSafe(tabId) {
      const pages = document.querySelectorAll(".page");
      pages.forEach(p => p.style.display = "none");
      const el = document.getElementById(tabId);
      if (el) el.style.display = "block";

      // Montajes por pestaña
      try {
        if (tabId === "pageUnits") {
          if (typeof renderUnits === "function") renderUnits();
        }
        if (tabId === "pagePeople") {
          if (typeof renderPersonnel === "function") renderPersonnel();
        }
        if (tabId === "pageChat") {
          if (typeof mountChat === "function") mountChat();
          else {
            if (typeof wireChatUI === "function") wireChatUI();
            if (typeof refreshChannels === "function") refreshChannels();
          }
        }
        if (tabId === "pageOrders") {
          if (typeof renderOrders === "function") renderOrders();
        }
        if (tabId === "pageEquip") {
          if (typeof renderEquipment === "function") renderEquipment();
        }
        if (tabId === "pageCUM") {
          if (typeof mountCUM === "function") mountCUM();
        }
        if (tabId === "pageDash") {
          safeRenderDashboard(false);
        }
      } catch (err) {
        console.error("openTabSafe mount error:", err);
      }
    }
    window.openTabSafe = openTabSafe;

    // Compat: si tu ui.js define openTab, lo usamos; si no, usamos openTabSafe
    function openTab(tabId) {
      if (typeof window.openTab === "function" && window.openTab !== openTab) {
        // Si ui.js tiene su propia función, la llamamos
        try { window.openTab(tabId); } catch(e) { openTabSafe(tabId); }
      } else {
        openTabSafe(tabId);
      }
    }
    // OJO: no machacamos el openTab de ui.js si existe
    if (typeof window.openTab !== "function") window.openTab = openTabSafe;

    // Dashboard safe wrapper
    async function safeRenderDashboard(force){
      try{
        const p = MILNET.profile || {};
        document.getElementById("dashBranch").textContent = p.branchId || "—";
        document.getElementById("dashUnit").textContent = p.unitId || "sin-unidad";
        document.getElementById("dashRank").textContent = p.rankId || "—";
        document.getElementById("dashClr").textContent = p.clearance || "BASIC";

        document.getElementById("dashBranchSub").textContent = "Cuerpo seleccionado";
        document.getElementById("dashUnitSub").textContent = "Tu unidad actual";
        document.getElementById("dashRankSub").textContent = "Tu rango";
        document.getElementById("dashClrSub").textContent = "Nivel de acceso";

        if (typeof renderDashboard === "function") {
          await renderDashboard(force);
        } else {
          document.getElementById("dashFeed").innerHTML =
            `<div class="small muted">dashboard.js no está listo. (renderDashboard no existe)</div>`;
        }
      }catch(err){
        console.error("safeRenderDashboard error:", err);
        const feed = document.getElementById("dashFeed");
        if (feed) feed.innerHTML = `<div class="small">Error en dashboard. Mira F12 → Console.</div>`;
      }
    }
    window.safeRenderDashboard = safeRenderDashboard;

    // Sidebar click wiring: usa data-tab (más limpio)
    function wireSidebarTabs() {
      document.querySelectorAll("[data-tab]").forEach(btn => {
        btn.addEventListener("click", () => openTabSafe(btn.getAttribute("data-tab")));
      });
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) return window.location.href = "login.html";
      MILNET.user = user;

      // cargar config (si existe)
      if (typeof loadConfig === "function") await loadConfig();

      // cargar/crear perfil
      const ref = firestore.collection("users").doc(user.uid);
      const snap = await ref.get();

      if (!snap.exists) {
        await ref.set({
          name: user.email.split("@")[0],
          email: user.email,
          branchId: "ETH",
          unitId: "sin-unidad",
          rankId: "soldado",
          rankLevel: 1,
          clearance: "BASIC",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      const snap2 = await ref.get();
      MILNET.profile = snap2.data() || {};

      // header
      document.getElementById("who").textContent =
        `${MILNET.profile.name} • ${MILNET.profile.branchId} • ${MILNET.profile.rankId} • unidad: ${MILNET.profile.unitId}`;

      // cuerpo
      if (!MILNET.config) {
        document.getElementById("branchName").textContent = MILNET.profile.branchId;
      } else {
        if (typeof setBranch === "function") setBranch(MILNET.profile.branchId || "ETH");
        else document.getElementById("branchName").textContent = MILNET.profile.branchId || "ETH";
      }

      // admin
      const king = (MILNET.profile.clearance === "KING") || ((MILNET.profile.rankLevel||0) >= 99);
      document.getElementById("btnAdmin").style.display = king ? "inline-flex" : "none";

      // permisos
      if (typeof renderPermissions === "function") renderPermissions();

      // wiring
      wireSidebarTabs();

      // Arranque: dashboard
      openTabSafe("pageDash");

      // precarga suave
      try { if (typeof wireChatUI === "function") wireChatUI(); } catch(e){}
      try { if (typeof refreshChannels === "function") refreshChannels(); } catch(e){}
      try { if (typeof renderOrders === "function") renderOrders(); } catch(e){}

      // Botón nuevo comunicado según permisos
      try {
        if (typeof canPublishOrders === "function") {
          document.getElementById("btnNewOrder").style.display = canPublishOrders() ? "inline-flex" : "none";
        }
      } catch(e){}
    });

    document.getElementById("logout").addEventListener("click", () => {
      auth.signOut().then(() => window.location.href="login.html");
    });
  </script>
</body>
</html>
